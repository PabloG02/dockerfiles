#!/bin/bash

display_usage() {
	echo -e "This script converts a PDB file generated by hdock to a PDB formatted file suitable for PDBePISA."
	echo -e "\nUsage:"
	echo -e "\t`basename $0` <input>"
	echo -e "\t`basename $0` <input> <output>"
} 

if [[ $1 == "--help" ]]; then
  display_usage
  exit 1
fi

if [ $# -lt 1 ] || [ $# -gt 2 ]; then
  tput setaf 1
  echo -e "Error. This script requires one or two arguments.\n"
  tput sgr0
  display_usage
  exit 0
fi

INPUT=$1
OUTPUT=${2-${INPUT}.PDBePISA.pdb}

echo 'Converting HDOCK' ${INPUT} 'file to be compatible with PDBePISA'

TMP_WORKING_DIR=$(mktemp -d /tmp/hdock_to_PDBePISA_conversion.XXXXXXX)

cd ${TMP_WORKING_DIR}

tail -n +8 ${INPUT} > tmp1
sed -i 's/ $//g' tmp1 ## sometimes hdock produces files with a blank space before the end of line
head -n -2 tmp1 > tmp2 && rm tmp1
csplit -z tmp2 /TER/ '{*}' 1> /dev/null && rm tmp2 && mv xx00 tmp3a
tail -n +3 xx01 > tmp3b && rm xx01
sed -i 's/$/  1.00 10.00      A   /g' tmp3a
sed -i -E 's/$/  1.00 10.00      B   /g; s/ A / B /g; s/ A([1-9])/ B\1/g' tmp3b
cat tmp3a tmp3b > tmp4 && rm tmp3a tmp3b
echo 'END' >> tmp4
mv tmp4 ${OUTPUT}

rm -rf ${TMP_WORKING_DIR}/*
